name: Portfolio CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Create new user
        shell: pwsh
        run: |
          $password = ConvertTo-SecureString -AsPlainText -Force 'QWE@#$asd234'
          New-LocalUser -Name "NUser" -Password $password -AccountNeverExpires:$true -Description "Remote Desktop User"

      - name: Add user to Remote Desktop Users group
        shell: pwsh
        run: Add-LocalGroupMember -Group "Remote Desktop Users" -Member "NUser"

      - name: Verify User Membership
        shell: pwsh
        run: Get-LocalGroupMember -Group "Remote Desktop Users"

      - name: Enable Remote Desktop for all users
        shell: pwsh
        run: |
          $rdp = Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server'
          $rdp.fDenyTSConnections = 0
          Set-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0

      - name: Enable Remote Desktop Firewall Rule
        shell: pwsh
        run: |
          $rule = Get-NetFirewallRule -DisplayName 'Remote Desktop - User Mode (TCP-In)'
          if ($rule -eq $null) {
            Write-Host "Remote Desktop Firewall Rule not found, creating it."
            New-NetFirewallRule -DisplayName 'Remote Desktop - User Mode (TCP-In)' -Direction Inbound -Protocol TCP -Action Allow -LocalPort 3389
          } else {
            Write-Host "Remote Desktop Firewall Rule already exists."
          }

      - name: Verify Remote Desktop Firewall Rule
        shell: pwsh
        run: Get-NetFirewallRule -DisplayName 'Remote Desktop - User Mode (TCP-In)'

      - name: Install Chocolatey
        shell: pwsh
        run: |
          Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
          choco feature enable -n allowGlobalConfirmation

      - name: Install Ngrok
        shell: pwsh
        run: choco install ngrok -y

      - name: Configure Ngrok
        shell: pwsh
        env:
          NGROK_AUTHTOKEN: 2NSZKcCIGFtFW3yjusLoKZCNF9r_6mQ6wS8TZwy5VYerBRYhu
        run: |
          $ngrokPath = "$env:ProgramData\chocolatey\bin\ngrok.exe"
          if (-not (Test-Path $ngrokPath)) {
            Write-Host "Ngrok not found at $ngrokPath"
            exit 1
          }
          if (-not $env:NGROK_AUTHTOKEN) {
            Write-Host "NGROK_AUTHTOKEN secret is not set. Add it in your repository settings."
            exit 1
          }
          try {
            # Configure auth token (v3 CLI)
            & $ngrokPath config add-authtoken $env:NGROK_AUTHTOKEN
          } catch {
            Write-Host "Failed to configure ngrok authtoken: $_"
            exit 1
          }

      - name: Start Ngrok
        shell: pwsh
        run: |
          $ngrokPath = "$env:ProgramData\chocolatey\bin\ngrok.exe"
          if (Test-Path $ngrokPath) {
            Start-Process -FilePath $ngrokPath -ArgumentList "tcp 3389" -NoNewWindow -Wait
          } else {
            Write-Host "Ngrok not found at $ngrokPath"
            exit 1
          }

      - name: Verify Ngrok Status
        shell: pwsh
        run: |
          $ngrokPath = "$env:ProgramData\chocolatey\bin\ngrok.exe"
          if (Test-Path $ngrokPath) {
            $status = & $ngrokPath status
            if ($status -match "tcp://") {
              Write-Host "Ngrok is running successfully."
            } else {  
              Write-Host "Ngrok is not running as expected."
              exit 1
            }
          } else {
            Write-Host "Ngrok not found at $ngrokPath"
            exit 1
          }

      - name: Stay 12 hrs
        shell: pwsh
        run: Start-Sleep -Seconds 43200
